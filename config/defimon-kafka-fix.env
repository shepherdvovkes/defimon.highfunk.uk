# =============================================================================
# DEFIMON KAFKA FIX CONFIGURATION
# =============================================================================
# Этот файл заменяет Kafka на Google Cloud Pub/Sub для избежания ошибок
# и улучшения производительности

# =============================================================================
# GOOGLE CLOUD PUB/SUB (ЗАМЕНА KAFKA)
# =============================================================================

# Google Cloud Pub/Sub Configuration (replaces Kafka)
GOOGLE_CLOUD_PUBSUB_TOPIC=defimon-events
GOOGLE_CLOUD_PUBSUB_SUBSCRIPTION=defimon-events-sub
GOOGLE_CLOUD_PUBSUB_ACK_DEADLINE=600
GOOGLE_CLOUD_PUBSUB_MAX_MESSAGES=1000
GOOGLE_CLOUD_PUBSUB_RETRY_POLICY_MAX_ATTEMPTS=5
GOOGLE_CLOUD_PUBSUB_RETRY_POLICY_MIN_BACKOFF=1
GOOGLE_CLOUD_PUBSUB_RETRY_POLICY_MAX_BACKOFF=600

# Event Streaming Configuration
EVENT_STREAM_ENABLED=true
EVENT_STREAM_BATCH_SIZE=100
EVENT_STREAM_FLUSH_INTERVAL=5
EVENT_STREAM_MAX_CONCURRENT_PUBLISHERS=10
EVENT_STREAM_ERROR_RETRY_ATTEMPTS=3
EVENT_STREAM_ERROR_RETRY_DELAY=5

# =============================================================================
# GETH NODE OPTIMIZATION
# =============================================================================

# Geth Node Configuration
GETH_SYNC_MODE=full
GETH_CACHE_SIZE=8192
GETH_DATABASE_CACHE=4096
GETH_TRIE_CACHE=256
GETH_SNAPSHOT_CACHE=256
GETH_STATE_CACHE=256
GETH_MAX_PEERS=50
GETH_HTTP_PORT=8545
GETH_WS_PORT=8546
GETH_P2P_PORT=30303

# Geth Performance Tuning
GETH_GC_MODE=archive
GETH_GC_INTERVAL=100000
GETH_GC_TARGET=1000000
GETH_GC_MEMORY=50000000
GETH_GC_CPU_FRACTION=0.25

# Geth Network Configuration
GETH_NETWORK_ID=1
GETH_DISCOVERY_V5=true
GETH_LIGHT_CLIENT=false
GETH_FAST_SYNC=false
GETH_SNAP_SYNC=false

# =============================================================================
# DATABASE OPTIMIZATION
# =============================================================================

# PostgreSQL Configuration
POSTGRES_MAX_CONNECTIONS=200
POSTGRES_SHARED_BUFFERS=256MB
POSTGRES_EFFECTIVE_CACHE_SIZE=1GB
POSTGRES_WORK_MEM=4MB
POSTGRES_MAINTENANCE_WORK_MEM=64MB
POSTGRES_CHECKPOINT_SEGMENTS=32
POSTGRES_WAL_BUFFERS=16MB
POSTGRES_DEFAULT_STATISTICS_TARGET=100

# ClickHouse Configuration (if used)
CLICKHOUSE_MAX_MEMORY_USAGE=8589934592
CLICKHOUSE_MAX_MEMORY_USAGE_FOR_USER=8589934592
CLICKHOUSE_MAX_CONCURRENT_QUERIES=100
CLICKHOUSE_MAX_CONNECTIONS=4096
CLICKHOUSE_KEEP_ALIVE_TIMEOUT=3
CLICKHOUSE_MAX_COMPRESSION_BLOCK_SIZE=1048576
CLICKHOUSE_MIN_COMPRESSION_BLOCK_SIZE=65536

# =============================================================================
# REDIS OPTIMIZATION
# =============================================================================

# Redis Configuration
REDIS_MAX_MEMORY=2gb
REDIS_MAX_MEMORY_POLICY=allkeys-lru
REDIS_SAVE_INTERVAL=900
REDIS_SAVE_CHANGES=1
REDIS_APPEND_ONLY=yes
REDIS_APPEND_FSYNC=everysec
REDIS_TCP_KEEPALIVE=300
REDIS_TCP_KEEPALIVE_INTERVAL=75
REDIS_TCP_KEEPALIVE_PROBES=9

# =============================================================================
# L2 NETWORKS OPTIMIZATION
# =============================================================================

# L2 Networks Configuration
L2_SYNC_ENABLED=true
L2_NETWORKS=optimism,arbitrum_one,polygon_zkevm,base,zksync_era,starknet,linea,scroll
L2_SYNC_INTERVAL=12
L2_BATCH_SIZE=100
L2_MAX_CONCURRENT_REQUESTS=10
L2_DATA_RETENTION_DAYS=90
L2_ARCHIVE_MODE=false
L2_PRIORITY_THRESHOLD=5

# L2 RPC Endpoints (with fallbacks)
L2_RPC_TIMEOUT=30
L2_RPC_RETRY_ATTEMPTS=3
L2_RPC_RETRY_DELAY=5
L2_RPC_RATE_LIMIT=100
L2_RPC_RATE_LIMIT_WINDOW=60

# =============================================================================
# MONITORING & LOGGING
# =============================================================================

# Prometheus Configuration
PROMETHEUS_ENABLED=true
PROMETHEUS_PORT=9090
PROMETHEUS_STORAGE_RETENTION=15d
PROMETHEUS_STORAGE_PATH=/data/prometheus
PROMETHEUS_MAX_CONCURRENT_SCRAPES=50
PROMETHEUS_SCRAPE_TIMEOUT=30s

# Grafana Configuration
GRAFANA_ENABLED=true
GRAFANA_PORT=3000
GRAFANA_SECURITY_ADMIN_PASSWORD=Cal1f0rn1a@2025
GRAFANA_SECURITY_ADMIN_USER=admin

# Logging Configuration
LOG_LEVEL=info
LOG_FORMAT=json
LOG_FILE=/data/logs/defimon.log
LOG_MAX_SIZE=100MB
LOG_MAX_BACKUPS=10
LOG_MAX_AGE=30d
LOG_COMPRESS=true

# =============================================================================
# SYSTEM OPTIMIZATION
# =============================================================================

# System Limits
SYSTEM_MAX_OPEN_FILES=65536
SYSTEM_MAX_USER_PROCESSES=32768
SYSTEM_VM_MAX_MAP_COUNT=262144
SYSTEM_VM_SWAPPINESS=1
SYSTEM_VM_DIRTY_RATIO=15
SYSTEM_VM_DIRTY_BACKGROUND_RATIO=5

# Docker Configuration
DOCKER_LOG_DRIVER=json-file
DOCKER_LOG_OPTS_MAX_SIZE=10m
DOCKER_LOG_OPTS_MAX_FILE=3
DOCKER_STORAGE_DRIVER=overlay2
DOCKER_DEFAULT_ULIMITS_NOFILE=65536

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# API Security
API_RATE_LIMIT_REQUESTS_PER_MINUTE=100
API_RATE_LIMIT_BURST_SIZE=200
API_CORS_ALLOWED_ORIGINS=*
API_CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS
API_CORS_ALLOWED_HEADERS=*

# JWT Configuration
JWT_SECRET_KEY=your-super-secure-jwt-secret-key-here
JWT_EXPIRATION_HOURS=24
JWT_REFRESH_TOKEN_EXPIRATION_DAYS=30

# =============================================================================
# BACKUP & RECOVERY
# =============================================================================

# Backup Configuration
BACKUP_ENABLED=true
BACKUP_SCHEDULE=0 2 * * *
BACKUP_RETENTION_DAYS=30
BACKUP_STORAGE_PATH=/data/backups
BACKUP_COMPRESSION=true

# =============================================================================
# DEVELOPMENT & DEBUGGING
# =============================================================================

# Development Mode
NODE_ENV=production
DEBUG=false
LOG_LEVEL=info

# Error Handling
ERROR_REPORTING_ENABLED=true
ERROR_REPORTING_SERVICE=sentry
ERROR_REPORTING_DSN=your-sentry-dsn
ERROR_REPORTING_ENVIRONMENT=production

# Performance Monitoring
PERFORMANCE_MONITORING_ENABLED=true
PERFORMANCE_MONITORING_SERVICE=newrelic
PERFORMANCE_MONITORING_LICENSE_KEY=your-newrelic-license-key
