#!/bin/bash

# ==============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SSH-–∫–ª—é—á–∞, –µ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
# –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª ~/.ssh/config.
# ==============================================================================

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
REMOTE_USER="vovkes"
REMOTE_HOST="192.168.0.153"
# –ü—Å–µ–≤–¥–æ–Ω–∏–º (–∞–ª–∏–∞—Å), –∫–æ—Ç–æ—Ä—ã–π –≤—ã –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: ssh vovkes-server
SSH_ALIAS="vovkes-server"

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
PRIVATE_KEY_PATH="$HOME/.ssh/id_rsa"
PUBLIC_KEY_PATH="${PRIVATE_KEY_PATH}.pub"
SSH_CONFIG_PATH="$HOME/.ssh/config"

echo "–ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH-–∫–ª—é—á–∞ –¥–ª—è ${REMOTE_USER}@${REMOTE_HOST}"
echo "---"

# --- –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SSH-–∫–ª—é—á–∞ ---
if [ ! -f "$PRIVATE_KEY_PATH" ]; then
    echo "SSH-–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –ì–µ–Ω–µ—Ä–∏—Ä—É—é –Ω–æ–≤—ã–π –∫–ª—é—á..."
    ssh-keygen -t rsa -b 4096 -f "$PRIVATE_KEY_PATH" -N ""
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ù–æ–≤—ã–π SSH-–∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω."
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞. –ü—Ä–µ—Ä—ã–≤–∞—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ."
        exit 1
    fi
else
    echo "‚ÑπÔ∏è  SSH-–∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ '$PRIVATE_KEY_PATH'. –ü—Ä–æ–ø—É—Å–∫–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é."
fi

echo "---"

# --- –®–ê–ì 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ---
if ! command -v ssh-copy-id &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–º–∞–Ω–¥–∞ 'ssh-copy-id' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ (–æ–±—ã—á–Ω–æ –ø–∞–∫–µ—Ç 'openssh-clients') –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á –≤—Ä—É—á–Ω—É—é."
    exit 1
fi

echo "–°–µ–π—á–∞—Å —è –ø–æ–ø—ã—Ç–∞—é—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä."
echo "–í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '${REMOTE_USER}' –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ${REMOTE_HOST}."
ssh-copy-id -i "$PUBLIC_KEY_PATH" "${REMOTE_USER}@${REMOTE_HOST}"

# --- –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ---
if [ $? -eq 0 ]; then
    echo ""
    echo "üéâ –£—Å–ø–µ—à–Ω–æ! –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${REMOTE_HOST}."
    echo "---"
    echo "–û–±–Ω–æ–≤–ª—è—é –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SSH (${SSH_CONFIG_PATH})..."

    # --- –®–ê–ì 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ ~/.ssh/config ---
    CONFIG_BLOCK="
Host ${SSH_ALIAS}
    HostName ${REMOTE_HOST}
    User ${REMOTE_USER}
    IdentityFile ${PRIVATE_KEY_PATH}
"
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .ssh —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    mkdir -p "$(dirname "${SSH_CONFIG_PATH}")"
    chmod 700 "$(dirname "${SSH_CONFIG_PATH}")"

    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ñ–∞–π–ª config —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
    touch "${SSH_CONFIG_PATH}"
    chmod 600 "${SSH_CONFIG_PATH}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–ø–∏—Å—å
    if grep -q "Host ${SSH_ALIAS}" "${SSH_CONFIG_PATH}"; then
        echo "‚ÑπÔ∏è  –ó–∞–ø–∏—Å—å –¥–ª—è —Ö–æ—Å—Ç–∞ '${SSH_ALIAS}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ñ–∞–π–ª–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü—Ä–æ–ø—É—Å–∫–∞—é."
    else
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
        echo "${CONFIG_BLOCK}" >> "${SSH_CONFIG_PATH}"
        echo "‚úÖ –ù–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è '${SSH_ALIAS}' –¥–æ–±–∞–≤–ª–µ–Ω–∞."
    fi

    echo ""
    echo "üéâ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∫–æ–º–∞–Ω–¥–æ–π:"
    echo ""
    echo "  ssh ${SSH_ALIAS}"
    echo ""
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞! –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á."
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –µ—â–µ —Ä–∞–∑, –ø—Ä–æ–≤–µ—Ä–∏–≤ –¥–∞–Ω–Ω—ã–µ."
fi
